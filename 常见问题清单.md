

### 1ã€openFeignç›´è¿apiï¼Œä¸ç»è¿‡nacos

```java
@FeignClient(value = "acc", url = "http://localhost:8092/acc")
public interface FeignAccountService {
    @PostMapping("/user/list")
    Result userList(@RequestBody UserListDTO userListDTO);
}
```

å‚è€ƒï¼š[[FEIGN ç›´è¿APIï¼ŒFEIGNä¸ä½¿ç”¨EUREKAç›´æ¥è°ƒç”¨å¾®æœåŠ¡](https://www.greenhtml.com/archives/feign-direct-api.html)](https://www.greenhtml.com/archives/feign-direct-api.html)

### 2ã€openFeignæ—¥å¿—æ‰“å°

feignæä¾›äº†æ—¥å¿—æ‰“å°åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡é…ç½®æ¥è°ƒæ•´æ—¥å¿—çº§åˆ«ï¼Œä»è€Œäº†è§£Feignä¸­HTTPè¯·æ±‚çš„ç»†èŠ‚
æ—¥å¿—çº§åˆ«æœ‰ä¸€ä¸‹å››ä¸ªï¼š
noneï¼šé»˜è®¤çš„ï¼Œä¸æ˜¾ç¤ºä»»ä½•æ—¥å¿—
basicï¼šä»…è®°å½•è¯·æ±‚æ–¹æ³•ï¼ŒURLå“åº”çŠ¶æ€ç ï¼ŒåŠæ‰§è¡Œæ—¶é—´
headersï¼šé™¤äº†basicä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–è¿˜æœ‰è¯·æ±‚å’Œå“åº”å¤´ä¿¡æ¯
fullï¼šé™¤äº†headersä¸­å®šä¹‰çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰è¯·æ±‚å’Œå“åº”çš„æ­£æ–‡åŠå…ƒæ•°æ®
å…·ä½“é…ç½®å¦‚ä¸‹ï¼š
ä¸€ã€ æ–°å»ºé…ç½®ç±»FeignConfig

```java
@Configuration
public class FeignConfig {
    @Bean
    Logger.Level feignLoggerLevel(){
        return Logger.Level.FULL;
    }
}
1234567
```

äºŒã€ymlæ–‡ä»¶

```java
logging:
  level:
     #feognæ—¥å¿—ä»¥ä»€ä¹ˆçº§åˆ«ç›‘è§†é‚£ä¸ªæ¥å£
     com.zhutianlu.springcloud.service.PaymentFeignService: debug
```

### 3 Feign Hystrix (HystrixCommonKey) è®¾ç½®å•ç‹¬æ¥å£çš„è¶…æ—¶æ—¶é—´å’ŒFallBack

å¦‚ä½•é…ç½®å¥½`Hystrix`å’Œ`Ribbon`çš„è¶…æ—¶æ—¶é—´å‘¢ï¼Ÿ
å…¶å®æ˜¯æœ‰å¥—è·¯çš„ã€‚å› ä¸º`Feign`çš„è¯·æ±‚ï¼šå…¶å®æ˜¯`Hystrix`+`Ribbon`ã€‚`Hystrix`åœ¨æœ€å¤–å±‚ï¼Œç„¶åå†åˆ°`Ribbon`ï¼Œæœ€åé‡Œé¢çš„æ˜¯`http`è¯·æ±‚ã€‚æ‰€ä»¥è¯´ã€‚`Hystrix`çš„ç†”æ–­æ—¶é—´å¿…é¡»å¤§äº`Ribbon`çš„ ( `ConnectTimeout` + `ReadTimeout` )ã€‚è€Œå¦‚æœ`Ribbon`å¼€å¯äº†é‡è¯•æœºåˆ¶ï¼Œè¿˜éœ€è¦ä¹˜ä»¥å¯¹åº”çš„é‡è¯•æ¬¡æ•°ï¼Œä¿è¯åœ¨`Ribbon`é‡Œçš„è¯·æ±‚è¿˜æ²¡ç»“æŸæ—¶ï¼Œ`Hystrix`çš„ç†”æ–­æ—¶é—´ä¸ä¼šè¶…æ—¶ã€‚

**å…ˆè¯´ç»“è®ºï¼šHystrixCommonKeyç”Ÿæˆæ–¹æ³•ï¼šç±»å#æ–¹æ³•å(å…¥å‚ç±»å‹)**

```yaml
hystrix:
  threadpool:
    default:
      # æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°  é»˜è®¤10
      coreSize: 20
      # æœ€å¤§æœ€å¤§çº¿ç¨‹æ± å¤§å°
      maximumSize: 30
      # æ­¤å±æ€§å…è®¸maximumSizeçš„é…ç½®ç”Ÿæ•ˆã€‚ é‚£ä¹ˆè¯¥å€¼å¯ä»¥ç­‰äºæˆ–é«˜äºcoreSizeã€‚ è®¾ç½®coreSize <maximumSizeä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œè¯¥çº¿ç¨‹æ± å¯ä»¥æ”¯æŒmaximumSizeå¹¶å‘ï¼Œä½†åœ¨ç›¸å¯¹ä¸æ´»åŠ¨æœŸé—´å°†å‘ç³»ç»Ÿè¿”å›çº¿ç¨‹ã€‚ ï¼ˆä»¥keepAliveTimeInMinutesä¸ºå‡†ï¼‰
      allowMaximumSizeToDivergeFromCoreSize: true
      # è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—
      maxQueueSize: 10
      # é˜Ÿåˆ—å¤§å°æ‹’ç»é˜€å€¼ åœ¨è¿˜æœªè¶…è¿‡è¯·æ±‚ç­‰å¾…é˜Ÿåˆ—æ—¶ä¹Ÿä¼šæ‹’ç»çš„å¤§å°
      queueSizeRejectionThreshold: 10
  command:
    LimitCheckApi#rcsLimitCheck(RpcRequest):  #defaultå…¨å±€æœ‰æ•ˆ é»˜è®¤å€¼ä¸º commonKey commonKeyç”Ÿæˆæ–¹æ³•åœ¨ Feign.configKey(target.type(), method) ä¸­
      fallback:
        enabled: true
      execution:
        timeout:
          #å¦‚æœenabledè®¾ç½®ä¸ºfalseï¼Œåˆ™è¯·æ±‚è¶…æ—¶äº¤ç»™ribbonæ§åˆ¶,ä¸ºtrue,åˆ™è¶…æ—¶ä½œä¸ºç†”æ–­æ ¹æ®
          enabled: true
        isolation:
          #éš”ç¦»ç­–ç•¥ï¼Œæœ‰THREADå’ŒSEMAPHORE
          #THREAD - å®ƒåœ¨å•ç‹¬çš„çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå¹¶å‘è¯·æ±‚å—çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡çš„é™åˆ¶
          #SEMAPHORE - å®ƒåœ¨è°ƒç”¨çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå¹¶å‘è¯·æ±‚å—åˆ°ä¿¡å·é‡è®¡æ•°çš„é™åˆ¶
          #å¯¹æ¯”ï¼šhttps://www.cnblogs.com/java-synchronized/p/7927726.html
          thread:
            timeoutInMilliseconds: 800 #æ–­è·¯å™¨è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤1000ms
    LimitCheckApi#testTimeOutFallBack(long):
      fallback:
        enabled: true
      execution:
        timeout:
            #å¦‚æœenabledè®¾ç½®ä¸ºfalseï¼Œåˆ™è¯·æ±‚è¶…æ—¶äº¤ç»™ribbonæ§åˆ¶,ä¸ºtrue,åˆ™è¶…æ—¶ä½œä¸ºç†”æ–­æ ¹æ®
            enabled: true
        isolation:
          #éš”ç¦»ç­–ç•¥ï¼Œæœ‰THREADå’ŒSEMAPHORE
          #THREAD - å®ƒåœ¨å•ç‹¬çš„çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå¹¶å‘è¯·æ±‚å—çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡çš„é™åˆ¶
          #SEMAPHORE - å®ƒåœ¨è°ƒç”¨çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå¹¶å‘è¯·æ±‚å—åˆ°ä¿¡å·é‡è®¡æ•°çš„é™åˆ¶
          #å¯¹æ¯”ï¼šhttps://www.cnblogs.com/java-synchronized/p/7927726.html
          thread:
            timeoutInMilliseconds: 800 #æ–­è·¯å™¨è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤1000ms
 
feign:
  hystrix:
    enabled: true
```

å‚è€ƒ: 

[Hystrixé’ˆå¯¹æŸä¸ªæ–¹æ³•å•ç‹¬è®¾ç½®è¶…æ—¶æ—¶é—´](https://blog.csdn.net/jerry010101/article/details/90143919?utm_medium=distribute.pc_relevant.none-task-blog-baidujs_title-2&spm=1001.2101.3001.4242)

[SpringCloud OpenFeignè¶…æ—¶é…ç½®è¯¦è§£](https://blog.csdn.net/a1036645146/article/details/108297183)

### 4 mybatis-plus è‡ªå®šä¹‰æŸ¥è¯¢SQL

- ä½¿ç”¨@selectæ³¨è§£ + Wrapper 

```java
@Select("select * from `user` ${ew.customSqlSegment}")
List<User> selectAll(@Param(Constants.WRAPPER) Wrapper wrapper);
```

- ä½¿ç”¨xml + Wrapper 

  ```java
  List<User> selectAll(@Param(Constants.WRAPPER) Wrapper wrapper);
  ```

  ```xml
  <select id="selectAll" resultType="com.zimug.example.model.User">
    select * from `user` ${ew.customSqlSegment}
  </select>
  ```

- æµ‹è¯•

  ```java
  @Test
  public void testCustomSQL2() {
    LambdaQueryWrapper<User> query = new LambdaQueryWrapper<>();
    query.eq(User::getName, "å­—æ¯");
  
    List<User> list = userMapper.selectAll(query);
    list.forEach(System.out::println);
  }
  ```


### 5ã€arthasçƒ­éƒ¨ç½²

- 1 jadå‘½ä»¤` å°†éœ€è¦æ›´æ”¹çš„æ–‡ä»¶å…ˆè¿›è¡Œåç¼–è¯‘ï¼Œä¿å­˜ä¸‹æ¥ ï¼Œç¼–è¯‘å™¨ä¿®æ”¹ã€‚ä¿®æ”¹å®Œä»¥åéœ€è¦å°†ç±»é‡æ–°åŠ è½½åˆ°JVM

```java
$ jad --source-only com.example.demo.DemoApplication > /data/DemoApplication.java
```

- 2 `SCå‘½ä»¤` â€œSearch-Classâ€ çš„ç®€å†™ï¼ŒæŸ¥æ‰¾å½“å‰ç±»æ˜¯å“ªä¸ªclassLoaderåŠ è½½çš„

  ```bash
  [arthas@16340]$ sc -d *ApiInterceptor |grep classLoader
   classLoaderHash   18b4aac2		#ç±»åŠ è½½å™¨  ç¼–å·
  ```

- 3 MC (Memory Compiler/å†…å­˜ç¼–è¯‘å™¨)ï¼Œç¼–è¯‘`.java`æ–‡ä»¶ç”Ÿæˆ`.class` 

  `MCå‘½ä»¤` ç”¨æŒ‡å®šçš„classloaderé‡æ–°å°†ç±»åœ¨å†…å­˜ä¸­ç¼–è¯‘

  ```bash
  $ mc -c 18b4aac2 /data/DemoApplication.java -d /data 
  Memory compiler output:
  /data/com/example/demo/DemoApplication.class
  ```

- 4 redefineï¼šåŠ è½½å¤–éƒ¨çš„`.class`æ–‡ä»¶ï¼Œredefine jvmå·²åŠ è½½çš„ç±»ã€‚

  ```bash
  $ redefine /data/com/example/demo/DemoApplication.class  
  redefine success, size: 1
  ```

  è¿™æ ·æˆ‘ä»¬å°±ç”¨`arthas`ç°å®äº†ä¸åœæœºã€ä¸å‘åŒ…æ›¿æ¢äº†ç”Ÿäº§ç¯å¢ƒçš„Javaä»£ç 

### 6.springbootæ‰“æˆjaråŒ…åæ— æ³•è§£å‹

Springbootæ‰“å‡ºæ¥çš„jarï¼Œç”¨å‹ç¼©å·¥å…·è§£å‹æŠ¥é”™ã€‚Why? å…ˆè¯´è§£å†³åŠæ³•

#### 1ã€è§£å†³åŠæ³•

> executableå±æ€§å¯¼è‡´çš„ï¼Œå±æ€§æ”¹æˆfalseåé‡æ–°æ‰“åŒ…ï¼Œå°±å¯ä»¥è§£å‹

```
<plugin>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-maven-plugin</artifactId>
    <configuration>
        <executable>true</executable>
    </configuration>
</plugin>
```

é‚£ä¹ˆï¼Œexecutableè®¾ç½®æˆtrueä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºä»€ä¹ˆè®¾ç½®æˆtrueå°±æ— æ³•è§£å‹å‘¢ï¼Ÿ

#### 2ã€executableè®¾ç½®æˆtrueä½œç”¨

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è¿è¡Œjarçš„æ–¹å¼ä¸ºï¼š

> java -jar xxx.jar

ä½†å¦‚æœä½ æƒ³åœ¨unix/linuxä¸Šï¼Œåƒæ‰§è¡ŒæŸä¸ªsh/æœåŠ¡é‚£æ ·è¿è¡Œjarï¼Œå°±éœ€è¦æŠŠä½ çš„appæ‰“åŒ…æˆexecutableçš„jarã€‚

å®˜æ–¹è§£é‡Šï¼š

> In addition to running Spring Boot applications by using `java -jar`, it is also possible to make fully executable applications for Unix systems. A fully executable jar can be executed like any other executable binary or it can be [registered with `init.d` or `systemd`](https://docs.spring.io/spring-boot/docs/current/reference/html/deployment-install.html#deployment-service). This makes it very easy to install and manage Spring Boot applications in common production environments.

ã€A fully executable jarã€‘å°±æ˜¯é€šè¿‡å‰é¢æåˆ°çš„ï¼Œæ‰“åŒ…æ—¶æŠŠexecutableè®¾ç½®ä¸ºtrueã€‚

#### 3ã€æ— æ³•è§£å‹çš„åŸå› åˆ†æ

å®Œå…¨å¯æ‰§è¡Œ çš„ jar/war åœ¨æ–‡ä»¶å‰é¢åµŒå…¥äº†ä¸ª é¢å¤–çš„è„šæœ¬ï¼Œè¿™å°±ä½¿å¾—æœ‰äº›å‘½ä»¤ä¼šæ‰§è¡Œå¤±è´¥ï¼Œæ¯”å¦‚ jar -xf ç­‰ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè§£å‹å·¥å…·æ— æ³•è§£å‹çš„åŸå› ã€‚

æ‰€ä»¥ï¼Œå¦‚æœä½ çš„jaræ˜¯é€šè¿‡ã€java -jarã€‘æ‰§è¡Œã€æˆ– æ”¾åœ¨servletå®¹å™¨ä¸­æ‰§è¡Œï¼Œé‚£ä¹ˆå»ºè®®å°†executableè®¾ç½®ä¸ºfalseã€‚

> Fully executable jars work by embedding an extra script at the front of the file. Currently, some tools do not accept this format, so you may not always be able to use this technique. For example, `jar -xf` may silently fail to extract a jar or war that has been made fully executable. It is recommended that you make your jar or war fully executable only if you intend to execute it directly, rather than running it with `java -jar` or deploying it to a servlet container.

#### 4ã€å‚è€ƒèµ„æ–™

https://docs.spring.io/spring-boot/docs/current/reference/html/deployment-install.html#deployment-service

### 7 logback æ—¥å¿—åˆ†éš”

éœ€æ±‚ï¼šå¼‚æ­¥è¾“å‡ºæ—¥å¿—ï¼Œæ—¥å¿—æ–‡ä»¶æŒ‰ç…§æ¯å¤©è¿›è¡Œåˆ†éš”ã€‚

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <contextName>logback</contextName>
    <!-- nameçš„å€¼æ˜¯å˜é‡çš„åç§°ï¼Œvalueçš„å€¼æ—¶å˜é‡å®šä¹‰çš„å€¼ã€‚é€šè¿‡å®šä¹‰çš„å€¼ä¼šè¢«æ’å…¥åˆ°loggerä¸Šä¸‹æ–‡ä¸­ã€‚å®šä¹‰å˜é‡åï¼Œå¯ä»¥ä½¿â€œ${}â€æ¥ä½¿ç”¨å˜é‡ã€‚ -->
    <property name="LOG_HOME" value="./logs" />
    <property name="FILE_NAME" value="api"/>

    <!--è¾“å‡ºåˆ°æ§åˆ¶å°-->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <!--æ­¤æ—¥å¿—appenderæ˜¯ä¸ºå¼€å‘ä½¿ç”¨ï¼Œåªé…ç½®æœ€åº•çº§åˆ«ï¼Œæ§åˆ¶å°è¾“å‡ºçš„æ—¥å¿—çº§åˆ«æ˜¯å¤§äºæˆ–ç­‰äºæ­¤çº§åˆ«çš„æ—¥å¿—ä¿¡æ¯-->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>debug</level>
        </filter>
        <encoder>
            <Pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</Pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!--è¾“å‡ºåˆ°æ–‡ä»¶-->
    <appender name="LOG_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- æ­£åœ¨è®°å½•çš„æ—¥å¿—æ–‡ä»¶çš„è·¯å¾„åŠæ–‡ä»¶å -->
        <file>${LOG_HOME}/${FILE_NAME}.log</file>
        <!--æ—¥å¿—æ–‡ä»¶è¾“å‡ºæ ¼å¼-->
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
        <!-- æ—¥å¿—è®°å½•å™¨çš„æ»šåŠ¨ç­–ç•¥ï¼ŒæŒ‰æ—¥æœŸï¼ŒæŒ‰å¤§å°è®°å½• -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- æ—¥å¿—å½’æ¡£ -->
            <!-- #######################	é‡ç‚¹è¿™é‡Œæœ‰å‘ï¼ï¼ï¼ ç”¨åˆ°äº†ä¸¤æ¬¡%dï¼Œç¬¬ä¸€ä¸ª%dæ˜¯ä¸ºäº†è·å–[å¹´æœˆ]ï¼Œç¬¬äºŒä¸ª%dæ‰æ˜¯æˆ‘ä»¬æœŸæœ›çš„æŒ‰ç…§æ—¥æœŸåˆ†éš”æ—¥å¿—ã€‚
				ä½†æ˜¯è¿™æ ·å†™å®Œåï¼Œlogbackåªè®¤ç¬¬ä¸€ä¸ª%d, æ‰€ä»¥å®é™…çš„æ•ˆæœæ˜¯æŒ‰ç…§æœˆä»½å¯¹æ—¥å¿—è¿›è¡Œåˆ†éš”ã€‚
ä¿®æ”¹ç¬¬ä¸€ä¸ª%dçš„å†™æ³•ä¸ºï¼š%d{yyyy-MM,aux} è¿™æ ·å°±å¯ä»¥æŒ‰ç…§æ—¥æœŸåˆ†éš”äº† -->
            <fileNamePattern>${LOG_HOME}/%d{yyyy-MM,aux}/${FILE_NAME}-%d{yyyy-MM-dd}-%i.log</fileNamePattern>
            <maxFileSize>100MB</maxFileSize>
            <!--æ—¥å¿—æ–‡ä»¶ä¿ç•™å¤©æ•°-->
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <!-- æ­¤æ—¥å¿—æ–‡ä»¶åªè®°å½•debugçº§åˆ«çš„ -->
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>debug</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
    </appender>

    <appender name="ASYNC_LOG_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <!-- ä¸ä¸¢å¤±æ—¥å¿—ï¼Œé»˜è®¤å€¼80ï¼Œå¦‚æœé˜Ÿåˆ—çš„80%å·²æ»¡,åˆ™ä¼šä¸¢å¼ƒTRACTã€DEBUGã€INFOçº§åˆ«çš„æ—¥å¿— -->
        <discardingThreshold>0</discardingThreshold>
        <!-- æ›´æ”¹é»˜è®¤çš„é˜Ÿåˆ—çš„æ·±åº¦,è¯¥å€¼ä¼šå½±å“æ€§èƒ½.é»˜è®¤å€¼256 -->
        <queueSize>256</queueSize>
        <!-- æ·»åŠ é™„åŠ çš„appender,æœ€å¤šåªèƒ½æ·»åŠ ä¸€ä¸ª -->
        <appender-ref ref="FILE_NAME"/>
    </appender>

    <!-- ########### è¿™é‡Œä¹Ÿæœ‰å‘ï¼šå¦‚æœä½¿ç”¨å¤šç¯å¢ƒé…ç½®springProfileå°±ä¸ä¼šå¯¹æ—¥å¿—è¿›è¡Œåˆ†éš”äº†ã€‚è¿˜æ²¡æ‰¾åˆ°åŸå› ï¼Œæš‚æ—¶è¿™æ ·å†™ -->
    <logger name="com.alibaba.nacos" level="INFO" additivity="false"/>
    <!-- æ—¥å¿—è¾“å‡ºçº§åˆ« -->
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="ASYNC_LOG_FILE"/>
    </root>
    
    <!-- æœŸæœ›æ”¹æˆå¦‚ä¸‹ï¼šæ”¯æŒå¤šç¯å¢ƒé…ç½®ã€‚è¿™ç§å†™æ³•å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼šæ—¥å¿—ä¸ä¼šæŒ‰ç…§æ—¥æœŸåˆ†éš”äº†ï¼Œè¿˜æ²¡æ‰¾åˆ°è§£å†³åŠæ³• -->
    <!--    <springProfile name="dev,test">-->
<!--        <logger name="com.alibaba.nacos" level="INFO" additivity="false"/>-->
<!--        <logger name="api" level="INFO">-->
<!--            <appender-ref ref="ASYNC_API_FILE"/>-->
<!--        </logger>-->
<!--        <root level="INFO">-->
<!--            <appender-ref ref="CONSOLE"/>-->
<!--            <appender-ref ref="ASYNC_INFO_FILE"/>-->
<!--        </root>-->
<!--    </springProfile>-->

<!--    <springProfile name="testprerel,abroad,inn,innprerel,innrel,innusa,online,prenew,preusa,testrel,yace">-->
<!--        <logger name="com.alibaba.nacos" level="INFO" additivity="false"/>-->
<!--        <logger name="api" level="INFO" additivity="false">-->
<!--            <appender-ref ref="ASYNC_API_FILE"/>-->
<!--        </logger>-->
<!--        <root level="INFO">-->
<!--            <appender-ref ref="ASYNC_INFO_FILE"/>-->
<!--        </root>-->
<!--    </springProfile>-->
</configuration>
```

### 8 [linuxå†…å­˜ä¸è¶³å¯¼è‡´javaè¿›ç¨‹è¢«killæ‰](https://www.cnblogs.com/zjhgx/p/12112440.html)

è®°å¾—ä¹‹å‰åœ¨å›½å†…ç°é‡‘è´·è´·è¶…æ”¾é‡æ—¶ï¼Œåå°javaè¿›ç¨‹è«åå¥‡å¦™å°±æ²¡äº†ï¼Œ

æŸ¥çœ‹ /var/log/message å‡ºç°å¦‚ä¸‹æ—¥å¿—ï¼Œæ ‡æ˜ï¼ŒLinux ç³»ç»Ÿè‡ªèº«æŠŠ Java è¿›ç¨‹æ€æ‰äº†

```
Jun 28 02:58:27 hilife-dev001 kernel: Out of memory: Kill process 14561 (java) score 52 or sacrifice child
```

å½“ Linux ç³»ç»Ÿå†…å­˜ä¸è¶³æ—¶ï¼Œç³»ç»Ÿä¼šæŠŠå½“å‰ç³»ç»Ÿå ç”¨ç³»ç»Ÿå†…å­˜è¿‡é«˜çš„è¿›ç¨‹å½“åšæµæ°“è¿›ç¨‹ï¼Œç„¶åç³»ç»Ÿå‘å‡ºä¿¡å·å°†è¿™ä¸ªæµæ°“è¿›ç¨‹æ€æ‰ï¼Œæœ€åå¯¼è‡´ Java åº”ç”¨æœåŠ¡ä¸èƒ½ä½¿ç”¨

è§£å†³æ–¹æ³•
æ–¹æ³•1ï¼šé€šè¿‡è°ƒæ•´ JVM å‚æ•°é™åˆ¶æœ€å¤§å¯ä½¿ç”¨å†…å­˜

-Xmx2g

æ–¹æ³•2ï¼šå¯ç”¨ swap åˆ†åŒº
å‚è€ƒ:https://help.aliyun.com/knowledge_detail/42534.html
æ–¹æ³•3ï¼šå¢åŠ ç‰©ç†å†…å­˜æˆ–å¢åŠ æœºå™¨
æ–¹æ³•4ï¼šå°†åº”ç”¨åˆ†é…åˆ°å‹åŠ›è¾ƒå°çš„æœåŠ¡å™¨ä¸Š

#### è®¾ç½®linuxåœ¨å†…å­˜ä¸è¶³çš„æ—¶å€™,ä¸ä¼šè‡ªåŠ¨æ€è¿›ç¨‹

cat /proc/versionï¼ŒæŸ¥çœ‹linuxå†…æ ¸ç‰ˆæœ¬
å¦‚æœlinuxå†…æ ¸ç‰ˆæœ¬<3.5ï¼Œé‚£ä¹ˆswapinessè®¾ç½®ä¸º0ï¼Œè¿™æ ·ç³»ç»Ÿå®æ„¿swapä¹Ÿä¸ä¼šoom killerï¼ˆæ€æ‰è¿›ç¨‹ï¼‰
å¦‚æœlinuxå†…æ ¸ç‰ˆæœ¬>=3.5ï¼Œé‚£ä¹ˆswapinessè®¾ç½®ä¸º1ï¼Œè¿™æ ·ç³»ç»Ÿå®æ„¿swapä¹Ÿä¸ä¼šoom killer
echo 0 > /proc/sys/vm/swappiness
echo vm.swapiness=0 >> /etc/sysctl.conf

### 9 æŸ¥çœ‹CPUè´Ÿè½½å’Œåˆ©ç”¨ç‡

https://mp.weixin.qq.com/s/M7Z6RSbMAZX1Lzl9sGWRxw

### **1.CPUè´Ÿè½½å’ŒCPUåˆ©ç”¨ç‡çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ**

é¦–å…ˆï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`uptime`ï¼Œ`w`æˆ–è€…`top`å‘½ä»¤çœ‹åˆ°CPUçš„å¹³å‡è´Ÿè½½ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhvwRIlJd8pSfSb6AAxw1kUhFPJ8KibRia4KxkHWHwBQvTOkhtib39Kxfvg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhDY6yINBYhEycwlZWr8XxGqhiaS5mozVMVZ3yq42H2dAyZWgQXxkFUqg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



**Load Average** ï¼šè´Ÿè½½çš„3ä¸ªæ•°å­—ï¼Œæ¯”å¦‚ä¸Šå›¾çš„4.86ï¼Œ5.28ï¼Œ5.00ï¼Œåˆ†åˆ«ä»£è¡¨ç³»ç»Ÿåœ¨è¿‡å»çš„1åˆ†é’Ÿï¼Œ5åˆ†é’Ÿï¼Œ15åˆ†é’Ÿå†…çš„ç³»ç»Ÿå¹³å‡è´Ÿè½½ã€‚ä»–ä»£è¡¨çš„æ˜¯**å½“å‰ç³»ç»Ÿæ­£åœ¨è¿è¡Œçš„å’Œå¤„äºç­‰å¾…è¿è¡Œçš„è¿›ç¨‹æ•°ä¹‹å’Œ**ã€‚ä¹ŸæŒ‡çš„æ˜¯å¤„äº**å¯è¿è¡ŒçŠ¶æ€**å’Œ**ä¸å¯ä¸­æ–­çŠ¶æ€**çš„å¹³å‡è¿›ç¨‹æ•°ã€‚

å¦‚æœå•æ ¸CPUçš„è¯ï¼Œè´Ÿè½½è¾¾åˆ°1å°±ä»£è¡¨CPUå·²ç»è¾¾åˆ°æ»¡è´Ÿè·çš„çŠ¶æ€äº†ï¼Œè¶…è¿‡1ï¼Œåé¢çš„è¿›è¡Œå°±éœ€è¦æ’é˜Ÿç­‰å¾…å¤„ç†äº†ã€‚

å¦‚æœæ˜¯æ˜¯å¤šæ ¸å¤šCPUçš„è¯ï¼Œå‡è®¾ç°åœ¨æœåŠ¡å™¨æ˜¯2ä¸ªCPUï¼Œæ¯ä¸ªCPU2ä¸ªæ ¸ï¼Œé‚£ä¹ˆæ€»è´Ÿè½½ä¸è¶…è¿‡4éƒ½æ²¡ä»€ä¹ˆé—®é¢˜ã€‚

æ€ä¹ˆæŸ¥çœ‹CPUæœ‰å¤šå°‘æ ¸å‘¢ï¼Ÿ

é€šè¿‡å‘½ä»¤`cat /proc/cpuinfo | grep "model name"`æŸ¥çœ‹CPUçš„æƒ…å†µã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhSuPhGGBMah9FW9Z6bI1lzsHwDCJiaepVIicic3JsD6GXl28ZBcJXR22Ag/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



é€šè¿‡`cat /proc/cpuinfo | grep "cpu cores"`æŸ¥çœ‹CPUçš„æ ¸æ•°

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhOemAFZSIiaase0bGTt4Mt8AXT4hJec9m26eQbvxrM6W1lI0QgPAglwA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



**CPU åˆ©ç”¨ç‡**ï¼šå’Œè´Ÿè½½ä¸åŒï¼ŒCPUåˆ©ç”¨ç‡æŒ‡çš„æ˜¯å½“å‰**æ­£åœ¨è¿è¡Œ**çš„è¿›ç¨‹å®æ—¶å ç”¨CPUçš„ç™¾åˆ†æ¯”ï¼Œä»–æ˜¯å¯¹ä¸€æ®µæ—¶é—´å†…CPUä½¿ç”¨çŠ¶å†µçš„ç»Ÿè®¡ã€‚

æˆ‘ä¸¾ä¸ªæ —å­ğŸŒ°ï¼š

å‡è®¾ä½ ä»¬å…¬å¸å•æ‰€æœ‰1ä¸ªå‘ä½ï¼Œæœ‰ä¸€ä¸ªäººå äº†å‘ä½ï¼Œè¿™æ—¶å€™è´Ÿè½½å°±æ˜¯1ï¼Œå¦‚æœè¿˜æœ‰ä¸€ä¸ªäººåœ¨æ’é˜Ÿï¼Œé‚£ä¹ˆè´Ÿè½½å°±æ˜¯2ã€‚

å¦‚æœåœ¨1ä¸ªå°æ—¶å†…ï¼ŒAä¸Šå•æ‰€èŠ±äº†10åˆ†é’Ÿï¼ŒBä¸Šå•æ‰€èŠ±äº†20åˆ†é’Ÿï¼Œå‰©ä¸‹30åˆ†é’Ÿå•æ‰€éƒ½æ²¡äººä½¿ç”¨ï¼Œé‚£ä¹ˆè¿™ä¸€ä¸ªå°æ—¶å†…åˆ©ç”¨ç‡å°±æ˜¯50%ã€‚

###  

### **2.é‚£å¦‚æœCPUè´Ÿè½½å¾ˆé«˜ï¼Œåˆ©ç”¨ç‡å´å¾ˆä½è¯¥æ€ä¹ˆåŠï¼Ÿ**

CPUè´Ÿè½½å¾ˆé«˜ï¼Œåˆ©ç”¨ç‡å´å¾ˆä½ï¼Œè¯´æ˜å¤„äºç­‰å¾…çŠ¶æ€çš„ä»»åŠ¡å¾ˆå¤šï¼Œè´Ÿè½½è¶Šé«˜ï¼Œä»£è¡¨å¯èƒ½å¾ˆå¤šåƒµæ­»çš„è¿›ç¨‹ã€‚é€šå¸¸è¿™ç§æƒ…å†µæ˜¯IOå¯†é›†å‹çš„ä»»åŠ¡ï¼Œå¤§é‡è¯·æ±‚åœ¨è¯·æ±‚ç›¸åŒçš„IOï¼Œå¯¼è‡´ä»»åŠ¡é˜Ÿåˆ—å †ç§¯ã€‚

åŒæ ·ï¼Œå¯ä»¥å…ˆé€šè¿‡`top`å‘½ä»¤è§‚å¯Ÿ(æˆªå›¾åªæ˜¯ç¤ºæ„ï¼Œä¸ä»£è¡¨çœŸå®æƒ…å†µ)ï¼Œå‡è®¾å‘ç°ç°åœ¨ç¡®å®æ˜¯é«˜è´Ÿè½½ä½ä½¿ç”¨ç‡ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhZtqWKVS8iad2rYo1Yj3BZ1pksWpkgdpicYms24qDnBLXFzJeOPFRJiciag/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



ç„¶åï¼Œå†é€šè¿‡å‘½ä»¤`ps -axjf`æŸ¥çœ‹æ˜¯å¦å­˜åœ¨çŠ¶æ€ä¸º`D+`çŠ¶æ€çš„è¿›ç¨‹ï¼Œè¿™ä¸ªçŠ¶æ€æŒ‡çš„å°±æ˜¯ä¸å¯ä¸­æ–­çš„ç¡çœ çŠ¶æ€çš„è¿›ç¨‹ã€‚å¤„äºè¿™ä¸ªçŠ¶æ€çš„è¿›ç¨‹æ— æ³•ç»ˆæ­¢ï¼Œä¹Ÿæ— æ³•è‡ªè¡Œé€€å‡ºï¼Œåªèƒ½é€šè¿‡æ¢å¤å…¶ä¾èµ–çš„èµ„æºæˆ–è€…é‡å¯ç³»ç»Ÿæ¥è§£å†³ã€‚(å¯¹ä¸èµ·ï¼Œæˆ‘æˆªä¸åˆ°D+çš„çŠ¶æ€)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhIM5P9GSeFqQ3cIgDiaNNPMpbMU5wJXZBw4fiaaT7CGSpDK1ntx9OUXfg/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



###  

### **3.é‚£å¦‚æœè´Ÿè½½å¾ˆä½ï¼Œåˆ©ç”¨ç‡å´å¾ˆé«˜å‘¢ï¼Ÿ**

å¦‚æœä½ çš„å…¬å¸åªæœ‰ä¸€ä¸ªå•æ‰€ï¼Œå¤–é¢æ²¡äººæ’é˜Ÿï¼Œå´æœ‰ä¸€ä¸ªäººåœ¨é‡Œé¢ä¸Šäº†å¤§åŠä¸ªå°æ—¶ï¼Œè¿™è¯´æ˜ä»€ä¹ˆï¼Ÿ

ä¸¤ç§å¯èƒ½ï¼šä»–æ²¡å¸¦çº¸ï¼Œæˆ–è€…ä¸€äº›å¥‡æ€ªçš„äº‹æƒ…å‘ç”Ÿäº†ï¼Ÿ

è¿™è¡¨ç¤ºCPUçš„ä»»åŠ¡å¹¶ä¸å¤šï¼Œä½†æ˜¯ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´å¾ˆé•¿ï¼Œå¤§æ¦‚ç‡å°±æ˜¯ä½ å†™çš„ä»£ç æœ¬èº«æœ‰é—®é¢˜ï¼Œé€šå¸¸æ˜¯è®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œç”Ÿæˆäº†å¤§é‡è€—æ—¶çŸ­çš„è®¡ç®—ä»»åŠ¡ã€‚

æ€ä¹ˆæ’æŸ¥ï¼Ÿç›´æ¥`top`å‘½ä»¤æ‰¾åˆ°ä½¿ç”¨ç‡æœ€é«˜çš„ä»»åŠ¡ï¼Œå®šä½åˆ°å»çœ‹çœ‹å°±è¡Œäº†ã€‚å¦‚æœä»£ç æ²¡æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆè¿‡æ®µæ—¶é—´CPUä½¿ç”¨ç‡å°±ä¼šä¸‹é™çš„ã€‚

###  

### **4.é‚£å¦‚æœCPUä½¿ç”¨ç‡è¾¾åˆ°100%å‘¢ï¼Ÿæ€ä¹ˆæ’æŸ¥ï¼Ÿ**

1. é€šè¿‡`top`æ‰¾åˆ°å ç”¨ç‡é«˜çš„è¿›ç¨‹ã€‚

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhuRsibVXxW9SRfyqpQ3BibwBQPtgsCBfDAaeXdYcVeQTUjuYYIocdqMeA/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



1. é€šè¿‡`top -Hp pid`æ‰¾åˆ°å ç”¨CPUé«˜çš„çº¿ç¨‹IDã€‚è¿™é‡Œæ‰¾åˆ°958çš„çº¿ç¨‹ID

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhRs9ZKX1UAuuABVHeqWiaMJsDOUjGIjUyHnJAbLEicWgD4iaWQYaibklbag/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



1. å†æŠŠçº¿ç¨‹IDè½¬åŒ–ä¸º16è¿›åˆ¶ï¼Œ`printf "0x%x\n" 958`ï¼Œå¾—åˆ°çº¿ç¨‹ID`0x3be`

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhKOCk3psjNH4lOMxJwKmP5033B8icpshzkQvdzDottaVh28kcZ6zJlxw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



1. é€šè¿‡å‘½ä»¤`jstack 163 | grep '0x3be' -C5 --color` æˆ–è€… `jstack 163|vim +/0x3be -` æ‰¾åˆ°æœ‰é—®é¢˜çš„ä»£ç 

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_jpg/ibBMVuDfkZUmvPFvQ3yVL1tQYGibHicYClhgPK9rmZ5npLAtgmIia4TLjFdGVrSXAAZeMn3m5RE8tKMLn9WBnU9CZw/640?wx_fmt=jpeg&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

### 5 å˜é‡ç›®å½•æŸ¥æ‰¾å†…å®¹

```shell

dir=/data/service/cloud-account/logs/2021-07
 
for file in $dir/*; do
    echo $file
    match=$(echo $file | grep "log.gz")
    if [ "$match" != "" ]
    then
        echo "$file æ˜¯å‹ç¼©æ–‡ä»¶"
    else
        echo "$file ä¸æ˜¯å‹ç¼©æ–‡ä»¶"
    fi
done


#!/bin/bash

dir=/data/service/cloud-account/logs/2021-07
cd $dir

#for file in $dir/*; do
for file in $(find  .  -name "api-*"  |  sort)
do
   # echo $file
    match=$(echo $file | grep "log.gz")
    if [ "$match" != "" ]
    then
        #echo "$file æ˜¯å‹ç¼©æ–‡ä»¶"
        echo $file
        gzip -dc $file | grep 'acc/v1/init' | grep 'osType=05' -c
    else
        #echo "$file ä¸æ˜¯å‹ç¼©æ–‡ä»¶"
        echo $file
        grep 'acc/v1/init' $file | grep 'osType=05' -c
    fi
done
```

### 6. awkç»Ÿè®¡

```shell
#!/bin/bash

dir=/data/service/cloud-gateway/logs/2021-07
cd $dir

for file in $(find  .  -name "info-*"  |  sort)
do
    #echo $file
    match=$(echo $file | grep "log.gz")
    if [ "$match" != "" ]
    then
        #echo $file
        #gzip -dc $file | grep 'No token in the request parameter' | awk -F"url =" '{print $2}' | sort | uniq -c| sort -rnk 1 >>url.txt
        # è¾“å‡ºåˆ°æ–‡ä»¶æ—¶æ²¡æœ‰æ¢è¡Œç¬¦äº†
        # echo "$(gzip -dc $file | grep 'No token in the request parameter' | awk -F'url =' '{print $2}' | sort | uniq -c| sort -rnk 1)"
        # å¯ä»¥çœ‹åˆ°ï¼Œæ¢è¡Œç¬¦æ²¡æœ‰äº†ã€‚åŠ ä¸ŠåŒå¼•å·å¯ä»¥æŠŠæ¢è¡Œç¬¦ä¿ç•™ä¸‹æ¥ï¼š
        echo "$(gzip -dc $file | grep 'No token in the request parameter' | awk -F'url =' '{print $2}' | sort | uniq -c| sort -rnk 1)"
    else
        #echo $file
        #grep 'No token in the request parameter' $file | awk -F"url =" '{print $2}' | sort | uniq -c| sort -rnk 1>url.txt
        echo "$(grep 'No token in the request parameter' $file | awk -F'url =' '{print $2}' | sort | uniq -c| sort -rnk 1)"
    fi
done

sh find.sh > url.txt

sh find.sh > url.txt

awk -F' ' 'BEGIN {count=0;}'
#TASK=`top -n 1 -Hp $PID | grep 'java' | sed -n '1,3p' |awk -F"end_gro+"  'BEGIN {count=0;} {name[count] = $1;count++;}; END{for (i = 0; i < NR; i++) print name[i]}'`

å¯¹å¦‚ä¸‹å†…å®¹åˆ†ç»„æ±‚å’Œ
12  baidu.com
2   google.com
34  bytedance.com
1  baidu.com
2   google.com
3  bytedance.com

awk '{s[$2] += $1}END{for(i in s) {print s[i],i}}' url.txt | sort -nrk 1
å‚è€ƒï¼šhttp://www.ttlsa.com/linux-command/awk-group-sum-group-statistics/
```



